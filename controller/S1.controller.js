/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["s2p/mm/im/goodsreceipt/purchaseorder/controller/BaseController","sap/ui/model/json/JSONModel","s2p/mm/im/goodsreceipt/purchaseorder/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","ui/s2p/mm/im/lib/materialmaster/controller/ValueHelpController","sap/m/MessageToast","sap/ui/generic/app/navigation/service/NavigationHandler"],function(B,J,f,F,a,V,M,N){"use strict";return B.extend("s2p.mm.im.goodsreceipt.purchaseorder.controller.S1",{formatter:f,onInit:function(){var t=this;var r=sap.ui.core.UIComponent.getRouterFor(this);this._oNavigationService=new sap.ui.generic.app.navigation.service.NavigationHandler(this,sap.ui.generic.app.navigation.service.ParamHandlingMode.URLParamWins);if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"){this._toggleBusy(true);if(!jQuery.support.touch){this.getView().addStyleClass("sapUiSizeCompact");}else{this.getView().byId("POInput").setWidth("100%");this.getView().byId("idTableSearch").setWidth("40%");}this._initController();if(sap.ushell){sap.ushell.services.AppConfiguration.addApplicationSettingsButtons([new sap.m.Button({text:this.getResourceBundle().getText("SETTINGS_TITLE"),press:jQuery.proxy(function(){this._showSettingsDialog({});},this)})]);}var c=sap.ui.core.Component.getOwnerIdFor(this.getView());var C=sap.ui.component(c).getComponentData();this._SourceOfGR="";this._SourceOfGRIsPurchaseOrder="PURORD";this._SourceOfGRIsInboundDelivery="INBDELIV";if(C&&C.startupParameters&&C.startupParameters.SourceOfGR){this._SourceOfGR=C.startupParameters.SourceOfGR[0];}else{this._SourceOfGR=jQuery.sap.getUriParameters().get("SourceOfGR");}if(this._SourceOfGR===null){this._SourceOfGR=this._SourceOfGRIsPurchaseOrder;}var d=this.getOwnerComponent().getModel("oData");d.setRefreshAfterChange(false);d.setDefaultCountMode(sap.ui.model.odata.CountMode.Inline);this.getView().setModel("oData",d);var m=this.getOwnerComponent().getModel("oDataHelp")||{};this._oDateFormat=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd.MM.yyyy",strictParsing:"true",UTC:"true"});var o=new sap.ui.model.json.JSONModel();o.setData(this._getInitFrontend());this.getView().setModel(o,"oFrontend");this._ResetStorageLocationBuffer=false;this._ResetBatchBuffer=false;r.attachRoutePatternMatched(this,this._handleRouteMatched);if(!this._oPostDialog){this._oPostDialog=sap.ui.xmlfragment({fragmentName:"s2p.mm.im.goodsreceipt.purchaseorder.view.successPost",type:"XML",id:"s2p.mm.im.goodsreceipt.purchaseorder.successPost"},this);this.getView().addDependent(this._oPostDialog);}var p={container:"s2p.mm.im.goodsreceipt.purchaseorder",item:"app"};if(sap.ushell&&sap.ushell.Container){this._oPersonalizer=sap.ushell.Container.getService("Personalization").getPersonalizer(p);}if(this._oPersonalizer){var P=this._oPersonalizer.getPersData().done(function(j){if(j){t._oPersonalizedDataContainer=j;if(!t._oPersonalizedDataContainer.PresetDocumentItemTextFromPO){t._oPersonalizedDataContainer.PresetDocumentItemTextFromPO=false;}if(!t._oPersonalizedDataContainer.SelectPO){t._oPersonalizedDataContainer.SelectPO=true;}if(!t._oPersonalizedDataContainer.SelectSTO){t._oPersonalizedDataContainer.SelectSTO=false;}if(!t._oPersonalizedDataContainer.EnableBarcodeScanning){t._oPersonalizedDataContainer.EnableBarcodeScanning=false;}t._setScanButtonVisibility();t._setSearchPlaceholderText();}}).fail(function(){jQuery.sap.log.error("Reading personalization data failed.");});}var s=jQuery.sap.getUriParameters().get("sap-mmim-testmode");if(!(s&&parseInt(s)>0)){if(C&&C.startupParameters&&C.startupParameters.sap_mmim_testmode){s=C.startupParameters.sap_mmim_testmode[0];}}if(s&&parseInt(s)>0){var b="/sap/opu/odata/sap/MMIM_EXTERNALTEST_SRV";var T=new sap.ui.model.odata.ODataModel(b,true);var e={};e.AverageProcessingDuration=""+parseInt(s);e.CreatedByUser="";var g="/TestModeSet";T.create(g,e,null,function(d,R){},this._handleOdataError);}if(sap.ushell&&sap.ushell.Container){var i=new Array();var I="#MaterialMovement-displayFactSheet?MaterialDocument=123&MaterialDocumentYear=2016";i.push(I);var h="#Supplier-displayFactSheet";i.push(h);if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){var k="#PurchaseOrder-displayFactSheet";i.push(k);}else{var l="#InboundDelivery-displayFactSheet";i.push(l);}var n="#Material-displayFactSheet";i.push(n);var q="#Batch-create";i.push(q);var S=sap.ushell.Container.getService("CrossApplicationNavigation");var u=S.isNavigationSupported(i).done(function(j){if(j){t._isIntentSupported.GoodsReceiptDisplay=j[0].supported||false;t._isIntentSupported.SupplierDisplay=j[1].supported||false;t._isIntentSupported.PurchaseOrderDisplay=j[2].supported||false;t._isIntentSupported.MaterialDisplay=j[3].supported||false;t._isIntentSupported.BatchCreate=j[4].supported||false;if(t.getView().getModel("oFrontend")){t.getView().getModel("oFrontend").setProperty("/SupplierDisplayActive",t._isIntentSupported.SupplierDisplay);t.getView().getModel("oFrontend").setProperty("/PurchaseOrderDisplayActive",t._isIntentSupported.PurchaseOrderDisplay);t.getView().getModel("oFrontend").setProperty("/MaterialDisplayActive",t._isIntentSupported.MaterialDisplay);t.getView().getModel("oFrontend").setProperty("/CreateBatchActive",t._isIntentSupported.BatchCreate);if(t._initialDataLoaded){t._initialDataLoaded.SupplierDisplayActive=t._isIntentSupported.SupplierDisplay;t._initialDataLoaded.PurchaseOrderDisplayActive=t._isIntentSupported.PurchaseOrderDisplay;t._initialDataLoaded.MaterialDisplayActive=t._isIntentSupported.MaterialDisplay;t._initialDataLoaded.CreateBatchActive=t._isIntentSupported.BatchCreate;}}}}).fail(function(){jQuery.sap.log.error("Reading intent data failed.");});}var v;var w;if(C&&C.startupParameters&&C.startupParameters.PurchaseOrder&&(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder)){v=C.startupParameters.PurchaseOrder[0];}if(C&&C.startupParameters&&C.startupParameters.InboundDelivery&&(this._SourceOfGR===this._SourceOfGRIsInboundDelivery)){v=C.startupParameters.InboundDelivery[0];}if(v){w=this.getView().byId("POInput");w.setValue(v);w.setEditable(false);w.fireChangeEvent(v);}else{this._oNavigationService.parseNavigation().done(function(A,j,z){if(A&&A.customData&&A.customData.Ebeln){if(t.getView().byId("POInput")){t.getView().byId("POInput").setValue(A.customData.Ebeln);}t._readPO(A.customData.Ebeln,A.customData);}});this._toggleBusy(false);}if(V){this._oValueHelpController=new V();this._oValueHelpController.init(m);}this._setSearchPlaceholderText();this._aExtendedFields=[];var x=d.getMetaModel().loaded().then(function(d){var G=t.getOwnerComponent().getModel("oData").getMetaModel().getODataEntityType("MMIM_GR4PO_DL_SRV.GR4PO_DL_Item").property;for(var j=0;j<G.length;j++){if(G[j]["sap:is-extension-field"]){if(JSON.parse(G[j]["sap:is-extension-field"])===true){t._aExtendedFields.push(G[j]);}}}if(t._aExtendedFields.length===0){t.getOwnerComponent().getModel("oData").setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);}});}if(this.getView().sViewName=="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){if(!jQuery.support.touch){this.getView().addStyleClass("sapUiSizeCompact");}var y=new sap.ui.model.json.JSONModel();this._oValueHelpController=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getController()._oValueHelpController;this._aValidStockTypes=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getController()._aValidStockTypes;this._oNavigationServiceFields={};this._oNavigationServiceFields.aHeaderFields=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getController()._oNavigationServiceFields.aHeaderFields;this._oNavigationServiceFields.aItemFields=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getController()._oNavigationServiceFields.aItemFields;this._aExtendedFields=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getController()._aExtendedFields;this.getView().setModel(y,"oItem");this.getView().setModel(r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S1",sap.ui.core.mvc.ViewType.XML).getModel("oFrontend"),"oFrontend");this.getView().byId("idGoodsMovementReasonCodeSelect").setModel("oData",this.getOwnerComponent().getModel("oData"));if(this._aExtendedFields.length){this.getView().getModel("oFrontend").setProperty("/ExtensionSectionVisible",true);this.getView().byId("idExtensionForm").setModel(this.getOwnerComponent().getModel("oData"));this.getView().byId("idExtensionForm").getModel().setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.getView().byId("idExtensionForm").getModel().setDeferredGroups(["edititems"]);this.getView().byId("idExtensionForm").getModel().setChangeBatchGroups({"GR4PO_DL_Header":{batchGroupId:"edititems"},"GR4PO_DL_Item":{batchGroupId:"edititems"}});}}this._oQuantFormat=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:3,minIntegerDigits:1,maxIntegerDigits:10,groupingEnabled:true});this._oBatchHelp={};this._NumberFormatter=sap.ui.core.format.NumberFormat.getFloatInstance({style:"short"});this._oMessagePopover=new sap.m.MessagePopover({items:{path:"message>/",template:new sap.m.MessagePopoverItem({longtextUrl:"{message>descriptionUrl}",type:"{message>type}",markupDescription:true,title:"{message>message}"})}});this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this.getView().addDependent(this._oMessagePopover);this.getView().getModel("message").attachMessageChange(null,this._onMessageChange,this);},_handleOdataError:function(e,t){if(!t){t=this;}t._toggleBusy(false);t.getView().getModel("message").fireMessageChange();},_toggleBusy:function(i){this.getView().byId("idProductsTable").setBusy(i);this.getView().byId("idProductsTable").setBusyIndicatorDelay(0);},onExit:function(){if(this._oValueHelpController){this._oValueHelpController.exit();}if(sap.m.InstanceManager.hasOpenPopover()){sap.m.InstanceManager.closeAllPopovers();}if(sap.m.InstanceManager.hasOpenDialog()){sap.m.InstanceManager.closeAllDialogs();}this.getView().getModel("message").detachMessageChange(this._onMessageChange,this);},onMessagesButtonPress:function(e){var m=e.getSource();this._oMessagePopover.toggle(m);},onAfterRendering:function(){if((this._MessageShown!==undefined)&&(this._MessageShown===false)){this._oMessagePopover.openBy(this.getView().byId("idMessageIndicator"));this._MessageShown=true;}if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){var b=[];b.push(new sap.ui.model.Filter("MovementType",sap.ui.model.FilterOperator.EQ,"101"));this.getView().byId("idGoodsMovementReasonCodeSelect").getBinding("items").filter(b);}},_onMessageChange:function(c){if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"&&this.getView().byId("idPage").getMessagesIndicator().getDomRef()!==null){this._oMessagePopover.openBy(this.getView().byId("idMessageIndicator"));}else{this._MessageShown=false;}},_loadAttachmentComponent:function(){try{var m=this.getView().getModel("oFrontend");var P=m.getProperty("/Ebeln");if(P){var t=this.getUniqueKey();var b="I";var o="BUS2017";this.temp_objectKey=P+"GR"+t;if(!this.oCompAttachProj){if(this.getOwnerComponent().getModel("oDataHelp").getServiceMetadata().dataServices.schema[0].entityType.length>=15){this.oCompAttachProj=sap.ui.getCore().createComponent({name:"sap.se.mi.plm.lib.attachmentservice.attachment",settings:{mode:b,objectKey:this.temp_objectKey,objectType:o}});this.getView().byId("idastestcompContainer").setComponent(this.oCompAttachProj);}else{m.setProperty("/AttachmentVisible",false);}}}}catch(e){m.setProperty("/AttachmentVisible",false);}},getUniqueKey:function(){var d=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"ddMMYYYYHHmmss"});var D=new Date();return d.format(D);},_getInitFrontend:function(){var m="50%";if(!jQuery.support.touch){m="35%";}var i={saveAsTileTitle:"",shareOnJamTitle:"",shareSendEmailSubject:"",shareSendEmailMessage:"",saveAsTileURL:"",saveAsTileSubtitle:"",shareInJamURL:"",searchPlaceholderText:"",fullscreenTitle:"",searchFieldLabel:"",visible:false,Objectheader:"",PostButtonEnabled:false,PostButtonVisible:false,ScanButtonVisible:false,DocumentDate:this._oDateFormat.format(new Date()),PostingDate:this._oDateFormat.format(new Date()),DocumentDate_valueState:sap.ui.core.ValueState.None,PostingDate_valueState:sap.ui.core.ValueState.None,ColumnBatchVisible:false,Items:[],VersionForPrintingSlip:this._aVersionForPrintingSlip,VersionForPrintingSlip_selectedKey:"0",SourceOfGR:this._SourceOfGR,ExtensionSectionVisible:false,maxSuggestionWidth:m};if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){i.fullscreenTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_PO");i.shareOnJamTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_PO");i.searchFieldLabel=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_PO");i.Ebeln_label=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_PO");i.Ebeln_maxLength=10;i.Ebeln_possibleLength=[10];}else{i.fullscreenTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_DL");i.shareOnJamTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_DL");i.searchFieldLabel=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_DL");i.Ebeln_label=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_DL");i.Ebeln_maxLength=9;i.Ebeln_possibleLength=[9];}return i;},_initController:function(){this._aVersionForPrintingSlip=[];this._aVersionForPrintingSlip.push({key:"0",text:this.getResourceBundle().getText("SELECT_ITEM_OUTPUT_NO")});this._aVersionForPrintingSlip.push({key:"1",text:this.getResourceBundle().getText("SELECT_ITEM_OUTPUT_IS")});this._aVersionForPrintingSlip.push({key:"2",text:this.getResourceBundle().getText("SELECT_ITEM_OUTPUT_ISIT")});this._aVersionForPrintingSlip.push({key:"3",text:this.getResourceBundle().getText("SELECT_ITEM_OUTPUT_CS")});this._oPersonalizedDataContainer={deliveredQuantityDefault2open:true,deliveredQuantityDefault20:false,PresetDocumentItemTextFromPO:false,SelectPO:true,SelectSTO:true,EnableBarcodeScanning:false};this._oNavigationServiceFields={aHeaderFields:["DocumentDate","PostingDate","Ebeln","DeliveryDocumentByVendor","MaterialDocumentHeaderText","BillOfLading","VersionForPrintingSlip_selectedKey"],aItemFields:["DocumentItem","DocumentItemText","DeliveredQuantity_input","DeliveredUnit_input","OpenQuantity","Unit","Plant","StorageLocation","StockType_selectedKey","DeliveryCompleted"]};this._isIntentSupported={GoodsReceiptDisplay:false,SupplierDisplay:false,MaterialDisplay:false,PurchaseOrderDisplay:false,BatchCreate:false};},concatenateNameIdFormatter:function(v,i){if(v){if(i!==""){v=v+" ("+i+")";}return v;}else{if(i){return i;}else{return null;}}},onNavBack:function(){var h=sap.ui.core.routing.History.getInstance(),p=h.getPreviousHash();var c=sap.ushell.Container.getService("CrossApplicationNavigation");if(p!==undefined||!c.isInitialNavigation()){c.backToPreviousApp();}else{c.toExternal({target:{shellHash:"#"}});}},onShareInJamPress:function(){var v=this.getModel("worklistView"),s=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:v.getProperty("/shareOnJamTitle")}}});s.open();},handleSuggest:function(e){var t=e.getParameter("suggestValue");if(t){var o={};var b=[];var c=[];var d={};if(t.length>3){b.push(new sap.ui.model.Filter("InboundDelivery",sap.ui.model.FilterOperator.Contains,t));}if(this._oPersonalizedDataContainer.SelectPO===true||this._SourceOfGR===this._SourceOfGRIsInboundDelivery){b.push(new sap.ui.model.Filter("VendorName",sap.ui.model.FilterOperator.Contains,t));}if(this._oPersonalizedDataContainer.SelectSTO===true&&this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){b.push(new sap.ui.model.Filter("SupplyingPlant",sap.ui.model.FilterOperator.Contains,t));b.push(new sap.ui.model.Filter("SupplyingPlantName",sap.ui.model.FilterOperator.Contains,t));}o=new sap.ui.model.Filter(b,false);c.push(o);c.push(new sap.ui.model.Filter("SourceOfGR",sap.ui.model.FilterOperator.EQ,this._SourceOfGR));d=new sap.ui.model.Filter(c,true);this.getView().byId("POInput").removeAllSuggestionColumns();var T=new sap.m.ColumnListItem({cells:[new sap.m.Label({text:"{oData>InboundDelivery}"})]});if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){this.getView().byId("POInput").addSuggestionColumn(new sap.m.Column({header:new sap.m.Label({text:this.getResourceBundle().getText("PO_SEARCH_FIELD_LABEL")})}));}else{this.getView().byId("POInput").addSuggestionColumn(new sap.m.Column({header:new sap.m.Label({text:this.getResourceBundle().getText("DL_SEARCH_FIELD_LABEL")})}));}if(this._oPersonalizedDataContainer.SelectPO===true||this._SourceOfGR===this._SourceOfGRIsInboundDelivery){T.addCell(new sap.m.Label({text:"{oData>VendorName}"}));this.getView().byId("POInput").addSuggestionColumn(new sap.m.Column({header:new sap.m.Label({text:this.getResourceBundle().getText("SUPPLIER_SEARCH_FIELD_LABEL")})}));}if(this._oPersonalizedDataContainer.SelectSTO===true&&this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){T.addCell(new sap.m.Label({text:"{oData>SupplyingPlant}"}));this.getView().byId("POInput").addSuggestionColumn(new sap.m.Column({header:new sap.m.Label({text:this.getResourceBundle().getText("SUPPLYINGPLANT_SEARCH_FIELD_LABEL")})}));}this.getView().byId("POInput").bindAggregation("suggestionRows",{path:"/GR4PO_DL_Headers",model:"oData",filters:c,template:T});this.getView().byId("POInput").getBinding("suggestionRows").attachDataReceived(this._setEbelnPossibleLength,this);}},_setEbelnPossibleLength:function(e){if(e.getParameter("data")&&e.getParameter("data").results.length>0){var E=this.getView().getModel("oFrontend").getProperty("/Ebeln_possibleLength");var s;for(var i=0;i<e.getParameter("data").results.length;i++){if(e.getParameter("data").results[i].InboundDelivery){s=e.getParameter("data").results[i].InboundDelivery;}else{if(e.getParameter("data").results[i].PurchaseOrder){s=e.getParameter("data").results[i].PurchaseOrder;}}if(E.indexOf(parseInt(s.length,10))===-1){E.push(parseInt(s.length,10));}}this.getView().getModel("oFrontend").setProperty("/Ebeln_possibleLength",E);}},handlePOHelp:function(e){var r=this.getResourceBundle();var t=this;var T="";if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){T=r.getText("TITLE_PO_HELP");}else{T=r.getText("TITLE_DL_HELP");}var p=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({id:"idValueHelpDialog",title:T,modal:true,supportMultiselect:false,supportRanges:false,supportRangesOnly:false,ok:function(g){var h=g.getParameter("tokens");var R=h[0].data();var i="";p.close();if(t._SourceOfGR===t._SourceOfGRIsPurchaseOrder){i=R.row.PurchaseOrder;}else{i=R.row.DeliveryDocument;}if(i){var o=t.getView().byId("POInput");o.setValue(i);o.fireChangeEvent(i);}},cancel:function(g){p.close();},afterClose:function(){p.destroy();}});var P="";var c=[];var s="";if(t._SourceOfGR===t._SourceOfGRIsPurchaseOrder){P="/PoHelpSet";c=[{label:r.getText("LABEL_PO_COL"),template:"PurchaseOrder"},{label:r.getText("LABEL_PO_TYPE_TEXT"),template:"PurchasingDocumentTypeName"},{label:r.getText("LABEL_PO_ITEMTYPE_TEXT"),template:"PurchaseOrderItem"}];s="PurchaseOrder,PurchaseOrderItem,PurchasingDocumentTypeName";if(t._oPersonalizedDataContainer.SelectPO===true){c.push({label:r.getText("LABEL_SUP_COL"),template:"Supplier"});c.push({label:r.getText("LABEL_SUP_NAME_COL"),template:"SupplierName"});c.push({label:r.getText("LABEL_CITY_COL"),template:"SupplierCityName"});s+=",Supplier,SupplierName,SupplierCityName";}if(t._oPersonalizedDataContainer.SelectSTO===true){c.push({label:r.getText("SUPPLYINGPLANT_SEARCH_FIELD_LABEL"),template:"SupplyingPlant"});c.push({label:r.getText("SUPPLYINGPLANTNAME_SEARCH_FIELD_LABEL"),template:"SupplyingPlantName"});s+=",SupplyingPlant,SupplyingPlantName";}c.push({label:r.getText("LABEL_MATERIAL_COL"),template:"Material"});c.push({label:r.getText("LABEL_MATERIAL_TXT_COL"),template:"PurchaseOrderItemText"});s+=",Material,PurchaseOrderItemText";}else{P="/InbDelHelpSet";c=[{label:r.getText("LABEL_DL_COL"),template:"DeliveryDocument"},{label:r.getText("LABEL_DL_ITEM_TEXT"),template:"DeliveryDocumentItem"},{label:r.getText("LABEL_MATERIAL_TXT_COL"),template:"DeliveryDocumentItemText"},{label:r.getText("LABEL_SUP_COL"),template:"Supplier"},{label:r.getText("LABEL_SUP_NAME_COL"),template:"SupplierName"},{label:r.getText("LABEL_CITY_COL"),template:"SupplierCityName"},{label:r.getText("LABEL_PO_COL"),template:"PurchaseOrder"},{label:r.getText("LABEL_PO_ITEMTYPE_TEXT"),template:"PurchaseOrderItem"}];s="DeliveryDocument,DeliveryDocumentItem,DeliveryDocumentItemText,PurchaseOrder,PurchaseOrderItem,Supplier,SupplierName,SupplierCityName";}var C=new sap.ui.model.json.JSONModel({cols:c});p.setModel(C,"columns");p.setModel(this.getView().getModel("oData"));var o=this.getView().byId("POInput");var b="";if(o.getValue().length>0){b=o.getValue();}var d=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,expandAdvancedArea:false,filterItems:[new sap.ui.comp.filterbar.FilterItem({name:"s1",label:this.getResourceBundle().getText("SEARCH_FIELD_TOOLTIP"),control:new sap.m.SearchField({value:b,tooltip:this.getResourceBundle().getText("SEARCH_FIELD_TOOLTIP"),showSearchButton:false})})],search:function(e){var g=e.getParameters();var S=g.selectionSet[0].getValue();if(S.length>0){var h={custom:{"search":S},select:s};p.getTable().bindAggregation("rows",{path:P,parameters:h,});p.setBusy(true);}else{p.getTable().bindAggregation("rows",{path:P,parameters:{select:s}});p.setBusy(true);}p.getTable().getBinding("rows").attachDataReceived(function(D){p.setBusy(false);t._setEbelnPossibleLength(D);},this);}});p.setFilterBar(d);if(b){var m={custom:{"search":b},select:s};p.getTable().bindAggregation("rows",{path:P,parameters:m,});p.setBusy(true);}else{p.getTable().bindAggregation("rows",{path:P,parameters:{select:s}});p.setBusy(true);}p.getTable().getBinding("rows").attachDataReceived(function(D){p.setBusy(false);t._setEbelnPossibleLength(D);},this);p.open();},handleStorageLocationHelp:function(e){var v=[];var b=[];var m="";var p="";if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"){var s=e.getSource();var P=s.getParent();var c=P.getCells();m=c[1].getText();m=m.substr(1,m.length-2);this._SelectedTableIndex=this._getSelectedItemInModel(e);var o=this.getView().getModel("oFrontend");var I=o.getProperty("/Items");p=I[this._SelectedTableIndex].Plant;v=I[this._SelectedTableIndex].StockType_input;}if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){var d=this.getModel("oItem");m=d.getProperty("/Material");p=d.getProperty("/Plant");v=d.getProperty("/StockType_input");}for(var i=0;i<v.length;i++){switch(v[i].key){case" ":b.push("CurrentStock");break;case"2":b.push("QualityInspectionStockQuantity");break;case"3":b.push("BlockedStockQuantity");}}var t=this;var g={};g.Material=m;g.Plant=p;g.DisplayedStockTypes=b;if(this._ResetStorageLocationBuffer===true){g.resetBuffer=true;this._ResetStorageLocationBuffer=false;}this._oValueHelpController.displayValueHelpStorageLocation4Material(g,function(r){t._handleValueHelpStorageLocationCallback(r);},t);},_handleValueHelpStorageLocationCallback:function(r){var s=false;if(r.selected===true){if(this.getView().sViewName=="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"){var m=this.getView().getModel("oFrontend");m.setProperty("/Items/"+this._SelectedTableIndex+"/StorageLocation",r.StorageLocation);m.setProperty("/Items/"+this._SelectedTableIndex+"/StorageLocation_input",r.StorageLocationName);m.setProperty("/Items/"+this._SelectedTableIndex+"/StorageLocation_valueState",sap.ui.core.ValueState.None);m.setProperty("/Items/"+this._SelectedTableIndex+"/StorageLocation_valueStateText","");s=this._ItemConsistent(m.getProperty("/Items/"+this._SelectedTableIndex));if(s==true){m.setProperty("/Items/"+this._SelectedTableIndex+"/SelectEnabled",s);m.setProperty("/Items/"+this._SelectedTableIndex+"/Selected",s);}this._setSelectEnabled(m.getProperty("/Items/"+this._SelectedTableIndex));this._controlSelectAllAndPostButton();}if(this.getView().sViewName=="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){var i=this.getView().getModel("oItem");i.setProperty("/StorageLocation",r.StorageLocation);i.setProperty("/StorageLocation_input",r.StorageLocationName);i.setProperty("/StorageLocation_valueState",sap.ui.core.ValueState.None);i.setProperty("/StorageLocation_valueStateText","");s=this._ItemConsistent(i.getData());if(s==true){i.setProperty("/SelectEnabled",s);i.setProperty("/Selected",s);i.setProperty("/ApplyButtonEnabled",s);}}}},handleAUoMHelp:function(e){var m="";var s=e.getSource();if(this.getView().sViewName=="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){m=this.getView().getModel("oItem").getProperty("/Material");}else{var p=s.getParent().getParent();var c=p.getCells();m=c[1].getText();m=m.substr(1,m.length-2);this._SelectedTableIndex=this._getSelectedItemInModel(e);}var t=this;var P={};P.Material=m;this._oValueHelpController.displayValueHelpAUOM4Material(P,function(r){t._handleValueHelpAUOMCallback(r);},t);},_handleValueHelpAUOMCallback:function(r){var m={};if(r.selected===true){if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){m=this.getView().getModel("oItem");var s=this._ItemConsistent(m.getData());if(s==true){m.setProperty("/SelectEnabled",s);m.setProperty("/Selected",s);}m.setProperty("/DeliveredUnit_input",r.AUoM);}else{m=this.getView().getModel("oFrontend");var i=m.getProperty("/Items");if(i[this._SelectedTableIndex].DeliveredUnit_input!==r.AUoM){i[this._SelectedTableIndex].DeliveredUnit_input=r.AUoM;}var s=this._ItemConsistent(i[this._SelectedTableIndex],i);if(s==true){i[this._SelectedTableIndex].SelectEnabled=s;i[this._SelectedTableIndex].Selected=s;}this._setSelectEnabled(i[this._SelectedTableIndex],i);this._controlSelectAllAndPostButton();m.setProperty("/Items",i);}}},handleBatchHelp:function(e){if(this._ResetBatchBuffer===true){this._ResetBatchBuffer=false;this._oBatchHelp={};}var i={};if(!this._oBatchDialog){this._oBatchDialog=sap.ui.xmlfragment(this.getView().getId(),"s2p.mm.im.goodsreceipt.purchaseorder.view.selectBatch",this);this.getView().addDependent(this._oBatchDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oBatchDialog);}if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){i=this.getView().getModel("oItem").getData();}else{var m=this.getView().getModel("oFrontend");i=m.getProperty("/Items/"+this._getSelectedItemInModel(e));this._SelectedTableIndex=this._getSelectedItemInModel(e);}var o=sap.ui.core.Fragment.byId(this.getView().getId(),"idBatchStockChart");var d="";o.removeAllData();for(var j=0;j<i.StockType_input.length;j++){switch(i.StockType_input[j].key){case"2":d="QualityInspectionStockQuantity";break;case"3":d="BlockedStockQuantity";break;default:d="CurrentStock";}o.addData(new sap.suite.ui.microchart.ComparisonMicroChartData({color:"Good",displayValue:"{oBatchCollection>"+d+"_Dis"+"}",value:"{oBatchCollection>"+d+"_Int"+"}",title:"{i18n>BATCH_VALUE_HELP_CHART_TITLE_"+d.toUpperCase()+"}"}));}if(!this._oBatchHelp[i.DocumentItem]){var b=[];b.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,i.Material));b.push(new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,i.Plant));b.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,i.Material));b.push(new sap.ui.model.Filter("StorageLocation",sap.ui.model.FilterOperator.EQ,i.StorageLocation));b.push(new sap.ui.model.Filter("DeliveryDocumentItem",sap.ui.model.FilterOperator.EQ,i.DocumentItem));b.push(new sap.ui.model.Filter("InboundDelivery",sap.ui.model.FilterOperator.EQ,this.getView().getModel("oFrontend").getProperty("/Ebeln")));this.getView().getModel("oData").read("/MaterialBatchHelps",{filters:b,success:jQuery.proxy(this._successBatchLoad,this,i),error:jQuery.proxy(this._handleOdataError,this)});}else{var c=new sap.ui.model.json.JSONModel();c.setDefaultBindingMode("OneWay");c.setProperty("/BatchCollection",this._oBatchHelp[i.DocumentItem]);var g=this._getMinMaxOfDisplayedStocks(this._oBatchHelp[i.DocumentItem],i.StockType_input);c.setProperty("/minValue",g.minValue);c.setProperty("/maxValue",g.maxValue);this._oBatchDialog.setModel(c,"oBatchCollection");this._oBatchDialog.open();}},_successBatchLoad:function(p,d){var b=new Array();for(var i=0;i<d.results.length;i++){var I={};I.Batch=d.results[i].Batch;I.BaseUnit=d.results[i].BaseUnit;I.BlockedStockQuantity_Dis=this._NumberFormatter.format(d.results[i].BlockedStockQuantity,I.BaseUnit)+" ";I.CurrentStock_Dis=this._NumberFormatter.format(d.results[i].CurrentStock,I.BaseUnit)+" ";I.QualityInspectionStockQuantity_Dis=this._NumberFormatter.format(d.results[i].QualityInspectionStockQuantity,I.BaseUnit)+" ";I.BlockedStockQuantity_Int=parseFloat(d.results[i].BlockedStockQuantity);I.CurrentStock_Int=parseFloat(d.results[i].CurrentStock);I.QualityInspectionStockQuantity_Int=parseFloat(d.results[i].QualityInspectionStockQuantity);I.BlockedStockQuantity=d.results[i].BlockedStockQuantity;I.CurrentStock=d.results[i].CurrentStock;I.QualityInspectionStockQuantity=d.results[i].QualityInspectionStockQuantity;b.push(I);}this._oBatchHelp[p.DocumentItem]=b;var o=new sap.ui.model.json.JSONModel();o.setDefaultBindingMode("OneWay");o.setProperty("/BatchCollection",this._oBatchHelp[p.DocumentItem]);var m=this._getMinMaxOfDisplayedStocks(this._oBatchHelp[p.DocumentItem],p.StockType_input);o.setProperty("/minValue",m.minValue);o.setProperty("/maxValue",m.maxValue);this._oBatchDialog.setModel(o,"oBatchCollection");this._oBatchDialog.open();},_getMinMaxOfDisplayedStocks:function(c,d){var m={minValue:0.0,maxValue:0.0};var D="";for(var i=0;i<d.length;i++){switch(d[i].key){case"2":D="QualityInspectionStockQuantity";break;case"3":D="BlockedStockQuantity";break;default:D="CurrentStock";}for(var j=0;j<c.length;j++){if(c[j][D+"_Int"]>m.maxValue){m.maxValue=c[j][D+"_Int"];}if(c[j][D+"_Int"]<m.minValue){m.minValue=c[j][D+"_Int"];}}}return m;},handleBatchValueHelpSearch:function(e){var v=e.getParameter("value");var o=new sap.ui.model.Filter("Batch",sap.ui.model.FilterOperator.Contains,v);var b=e.getSource().getBinding("items");b.filter([o]);},handleBatchValueHelpCancel:function(e){e.getSource().getBinding("items").filter([]);},handleBatchValueHelpConfirm:function(e){e.getSource().getBinding("items").filter([]);var c=e.getParameter("selectedContexts");e.getSource().getBinding("items").filter([]);if(c.length){if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){this.getView().getModel("oItem").setProperty("/Batch",c[0].getObject().Batch);}else{var m=this.getView().getModel("oFrontend");m.setProperty("/Items/"+this._SelectedTableIndex+"/Batch",c[0].getObject().Batch);}}},handleCreateBatch:function(e){var p={Material:this.getView().getModel("oItem").getProperty("/Material"),Plant:this.getView().getModel("oItem").getProperty("/Plant")};this._ResetBatchBuffer=true;this._oNavigationService.navigate("Batch","create",p,this._getInnerAppState());},handleSearch:function(e){var v=e.getParameter("query");var t=this.getView().byId("idProductsTable");var m=this.getView().getModel("oFrontend");var b=t.getBinding("items");var o={};var c=[];if(v.length>0){c.push(new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,v));c.push(new sap.ui.model.Filter("MaterialName",sap.ui.model.FilterOperator.Contains,v));c.push(new sap.ui.model.Filter("PurchaseOrderItemText",sap.ui.model.FilterOperator.Contains,v));o=new sap.ui.model.Filter(c,false);t.getBinding("items").filter(o);}else{t.getBinding("items").filter([]);}var r=this.getResourceBundle();var I=t.getItems();var d=0;for(var i=0;i<I.length;i++){var g=I[i].getCells()[0].getProperty("visible");if(g==true){d++;}}var p=r.getText("TABLE_ITEMS_LABEL",[d,this._iTableRowsCount]);m.setProperty("/POItemsCountTableHeader",p);},onDisplayAccountAssignment:function(e){if(!this._oAccAssDialog){this._oAccAssDialog=sap.ui.xmlfragment("s2p.mm.im.goodsreceipt.purchaseorder.view.accountAssignment",this);this.getView().addDependent(this._oAccAssDialog);}var s=this._getSelectedItemInModel(e);var o=this.getView().getModel("oFrontend");var m=o.getData();var i=m.Items[s];var I=new sap.ui.model.json.JSONModel();I.setData(i);this._oAccAssDialog.setModel(I,"oItem");var b=e.getSource();jQuery.sap.delayedCall(0,this,function(){this._oAccAssDialog.openBy(b);});},handleSelectAll:function(e){var s=e.getParameter("selected");var m=this.getView().getModel("oFrontend");var I=m.getProperty("/Items");if(s){for(var i=0;i<I.length;i++){if(I[i].SelectEnabled){I[i].Selected=true;}m.setProperty("/PostButtonEnabled",true);}}else{for(var i=0;i<I.length;i++){if(I[i].SelectEnabled){I[i].Selected=false;}m.setProperty("/PostButtonEnabled",false);}}m.setProperty("/Items",I);},handleSelect:function(e){var s=e.getParameter("selected");var m=this.getView().getModel("oFrontend");var I=m.getProperty("/Items");var S=this.getView().byId("idSelectAll");S.setSelected(this._allItemsInTableSelected(I));var b=this._getSelectedItemInModel(e);var c=I[b].DocumentItem;var d=0;for(var i=0;i<I.length;i++){if(I[i].DocumentItem==c){I[i].Selected=s;}if(I[i].Selected){d++;}}if(d>0){m.setProperty("/PostButtonEnabled",true);}else{m.setProperty("/PostButtonEnabled",false);}m.setProperty("/Items",I);},handleInputChange:function(e){var i=e.getSource();if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){var I=this.getView().getModel("oItem");if(this._oQuantFormat.parse(i.getValue())>=0){I.setProperty("/DeliveredQuantity_valueState",sap.ui.core.ValueState.None);I.setProperty("/DeliveredQuantity_valueStateText","");if(I.getProperty("/StorageLocation_input")===""&&I.getProperty("/StorageLocationVisible")==true){I.setProperty("/StorageLocation_valueState",sap.ui.core.ValueState.Error);I.setProperty("/StorageLocation_valueStateText",this.getResourceBundle().getText("STORAGELOCATION_VALUE_STATE_TEXT"));}var b=this._ItemConsistent(I.getData());I.setProperty("/Selected",b);I.setProperty("/SelectEnabled",b);I.setProperty("/ApplyButtonEnabled",b);}else{I.setProperty("/Selected",false);I.setProperty("/SelectEnabled",false);I.setProperty("/ApplyButtonEnabled",false);I.setProperty("/DeliveredQuantity_valueState",sap.ui.core.ValueState.Error);I.setProperty("/DeliveredQuantity_valueStateText",this.getResourceBundle().getText("DELIVEREDQUANTITY_VALUE_STATE_TEXT"));}}else{var s=this._getSelectedItemInModel(e);var m=this.getView().getModel("oFrontend");if(this._oQuantFormat.parse(i.getValue())>=0){m.setProperty("/Items/"+s+"/DeliveredQuantity_valueState",sap.ui.core.ValueState.None);m.setProperty("/Items/"+s+"/DeliveredQuantity_valueStateText","");if(m.getProperty("/Items/"+s+"/StorageLocation_input")==""&&m.getProperty("/Items/"+s+"/StorageLocationVisible")==true){m.setProperty("/Items/"+s+"/StorageLocation_valueState",sap.ui.core.ValueState.Error);m.setProperty("/Items/"+s+"/StorageLocation_valueStateText",this.getResourceBundle().getText("STORAGELOCATION_VALUE_STATE_TEXT"));}var b=this._ItemConsistent(m.getProperty("/Items")[s],m.getProperty("/Items"));m.setProperty("/Items/"+s+"/Selected",b);m.setProperty("/Items/"+s+"/SelectEnabled",b);var c=m.getProperty("/Items");this._setSelectEnabled(c[s],c);c=m.getProperty("/Items");this._controlSelectAllAndPostButton(c);}else{m.setProperty("/Items/"+s+"/DeliveredQuantity_valueState",sap.ui.core.ValueState.Error);m.setProperty("/Items/"+s+"/DeliveredQuantity_valueStateText",this.getResourceBundle().getText("DELIVEREDQUANTITY_VALUE_STATE_TEXT"));m.setProperty("/Items/"+s+"/Selected",false);m.setProperty("/Items/"+s+"/SelectEnabled",false);var c=m.getProperty("/Items");this._setSelectEnabled(c[s],c);this._controlSelectAllAndPostButton(c);}}},handleStockTypeChange:function(e){var c=e.getSource().getSelectedItem().data("ControlOfBatchTableField");var C=e.getSource().getSelectedItem().data("ControlOfReasonCodeTableField");var i={};if(this.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S2"){i=this.getView().getModel("oItem").getData();this._evaluateFieldControl("Batch",c,i);this._evaluateFieldControl("GoodsMovementReasonCode",C,i);this.getView().getModel("oItem").setData(i);}else{var s=this._getSelectedItemInModel(e);var m=this.getView().getModel("oFrontend");i=m.getProperty("/Items/"+s);this._evaluateFieldControl("Batch",c,i);this._evaluateFieldControl("GoodsMovementReasonCode",C,i);m.setProperty("/Items/"+s,i);}if(i.BatchVisible===true){this.getView().getModel("oFrontend").setProperty("/ColumnBatchVisible",true);}},handleDateChange:function(e){var v=sap.ui.core.ValueState.None;if(e.getParameter("valid")==false||e.getParameters().value==""){v=sap.ui.core.ValueState.Error;}e.getSource().setValueState(v);this._controlSelectAllAndPostButton();},handleUpperCase:function(e){var v=e.getSource().getValue();if(v){e.getSource().setValue(v.toUpperCase());}},handleItemSplit:function(e){var s=this._getSelectedItemInModel(e);var o=this.getView().getModel("oFrontend");var m=o.getData();if(m.Items[s].SplitButtonIcon==="sap-icon://add"){var n=JSON.parse(JSON.stringify(m.Items[s]));n.ItemCounter=this._getMaxItemOfDocumentIteminModel(m.Items[s].DocumentItem,o);n.ItemCounter++;n.SplitEnabled=true;n.MaterialVisible=false;n.AccountAssignmentVisible=false;n.PlantVisible=false;n.StorageLocationVisible=true;n.StockTypeVisible=true;n.DeliveredQuantity_input=0;n.SplitButtonIcon="sap-icon://less";n.SplitButtonText="";m.Items.splice(++s,0,n);o.setData(m);}else{m.Items.splice(s,1);o.setData(m);}},handleDetailPress:function(e){var r=sap.ui.core.UIComponent.getRouterFor(this);var o=this.getView().getModel("oFrontend");var i=o.getProperty("/Items");var s=this._getSelectedItemInModel(e);r.navTo("subscreen",{POItem:s});},handleNavButtonPress:function(e){var I=this.getModel("oItem").getData();var o=this.getModel("oFrontend");var b=o.getProperty("/Items");if(this._aExtendedFields&&this._aExtendedFields.length>0){var c=this.getView().byId("idExtensionForm").getElementBinding().getBoundContext().getObject();for(var i=0;i<this._aExtendedFields.length;i++){if(this._isExtendedField(this._aExtendedFields[i].name)===true){I[this._aExtendedFields[i].name]=c[this._aExtendedFields[i].name];}}}if(this._ItemConsistent(I,b)){if(b){for(var i=0;i<b.length;i++){if(b[i].DocumentItem===I.DocumentItem&&b[i].ItemCounter===I.ItemCounter){b[i]=I;}}o.setProperty("/Items",b);}this._setSelectEnabled(I,b);}var r=sap.ui.core.UIComponent.getRouterFor(this);r.navTo("fullscreen",{abort:"false"},true);},handleCancelButtonPress:function(e){var r=sap.ui.core.UIComponent.getRouterFor(this);r.navTo("fullscreen",{abort:"true"},true);},handleNavButtonPressS1:function(e){var t=this;var r=t.getResourceBundle();var C=true;var c=JSON.stringify(this.getView().getModel("oFrontend").getData());if(c&&this._initialDataLoaded&&(this._initialDataLoaded!=null)){var o=JSON.stringify(this._initialDataLoaded);if(o!==c){var C=false;sap.m.MessageBox.confirm(r.getText("MESSAGE_DATA_LOSS"),{icon:sap.m.MessageBox.Icon.QUESTION,title:r.getText("MESSAGE_DATA_LOSS_TITLE"),onClose:b,styleClass:"sapUiSizeCompact",initialFocus:sap.m.MessageBox.Action.CANCEL});}}if(C==true){window.history.back();}function b(R){if(R===true){window.history.back();}}},_handleRouteMatched:function(e,c){if(c.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"&&e.getParameters().name==="fullscreen"){var A="true";A=e.getParameter("arguments").abort;if(A==="false"){var o=c.getView().getModel("oFrontend");var i=o.getProperty("/Items");c._controlSelectAllAndPostButton(i);}}else{if(c.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"&&(e.getParameters().name==="fullscreen2"||e.getParameters().name==="fullscreen3")){var h=sap.ui.core.routing.HashChanger.getInstance();var H=h.getHash();if(H.indexOf("key")>-1){var k=H.split("/");if(k.length>=2){var p=k[k.length-1];var P=c.getView().byId("POInput");if(P.getValue()!==p){P.setValue(p);P.fireChangeEvent(p);}}}}else{if(c.getView().sViewName==="s2p.mm.im.goodsreceipt.purchaseorder.view.S1"&&(e.getParameters().name==="fullscreen4")){}else{var r=sap.ui.core.UIComponent.getRouterFor(c);var I=c.getModel("oFrontend").getProperty("/Items/"+e.getParameter("arguments").POItem+"/");var n=new sap.ui.model.json.JSONModel(JSON.parse(JSON.stringify(I)));var v=r.getView("s2p.mm.im.goodsreceipt.purchaseorder.view.S2",sap.ui.core.mvc.ViewType.XML);v.setModel(n,"oItem");v.setModel(c.getModel("oFrontend"),"oFrontend");if(c._aExtendedFields&&c._aExtendedFields.length>0){var d=c.getOwnerComponent().getModel("oData");var s=e.getParameter('arguments').POItem;v.byId("idExtensionForm").bindElement({path:"/GR4PO_DL_Items(InboundDelivery='"+c.getModel("oFrontend").getProperty("/Ebeln")+"',DeliveryDocumentItem='"+I.DocumentItem+"',SourceOfGR='"+c._SourceOfGR+"')"});}}}}},_allItemsInTableSelected:function(t){var I=[];if(t){I=t;}else{var m=this.getView().getModel("oFrontend");I=m.getProperty("/Items");}var s=false;if(I.length>0){s=true;for(var i=0;i<I.length;i++){if((I[i].Selected==false)&&(I[i].ItemCounter==0)){s=false;}}}return s;},_oneItemsInTableSelected:function(t){var I=[];if(t){I=t;}else{var m=this.getView().getModel("oFrontend");I=m.getProperty("/Items");}var s=false;for(var i=0;i<I.length;i++){if((I[i].Selected==true)&&(I[i].ItemCounter==0)){s=true;}}return s;},_oneItemsInTableEnabled:function(t){var I=[];if(t){I=t;}else{var m=this.getView().getModel("oFrontend");I=m.getProperty("/Items");}var s=false;for(var i=0;i<I.length;i++){if((I[i].SelectEnabled==true)&&(I[i].ItemCounter==0)){s=true;}}return s;},_ItemConsistent:function(I,t){var b;if(t){b=t;}else{var m=this.getView().getModel("oFrontend");b=m.getProperty("/Items");}var c=function(o){for(var p in o){if((p.indexOf("_valueState")>0)&&(p.indexOf("_valueStateText")<0)){if((o[p]!=sap.ui.core.ValueState.None)&&(o[p]!=sap.ui.core.ValueState.Success)){C=false;}}}};var C=true;for(var i=0;i<b.length;i++){if(b[i].DocumentItem==I.DocumentItem){if(b[i].ItemCounter==I.ItemCounter){c(I);}else{c(b[i]);}}}return C;},_controlSelectAllAndPostButton:function(t){var i=[];var m=this.getView().getModel("oFrontend");if(t){i=t;}else{i=m.getProperty("/Items");}if((m.getProperty("/DocumentDate_valueState")==sap.ui.core.ValueState.None)&&(m.getProperty("/PostingDate_valueState")==sap.ui.core.ValueState.None)){m.setProperty("/PostButtonEnabled",this._oneItemsInTableSelected(i));}else{m.setProperty("/PostButtonEnabled",false);}this.getView().byId("idSelectAll").setSelected(this._allItemsInTableSelected(i));this.getView().byId("idSelectAll").setEnabled(this._oneItemsInTableEnabled(i));},_setSelectEnabled:function(I,t){var b;var m=this.getView().getModel("oFrontend");if(t){b=t;}else{b=m.getProperty("/Items");}for(var i=0;i<b.length;i++){if(b[i].DocumentItem==I.DocumentItem&&(b[i].Selected!==I.Selected||b[i].SelectEnabled!==I.SelectEnabled)){m.setProperty("/Items/"+i+"/SelectEnabled",I.SelectEnabled);m.setProperty("/Items/"+i+"/Selected",I.Selected);}}},_getSelectedItemInModel:function(e){var p=e.getSource().getBindingContext("oFrontend").getPath();return parseInt(p.substring(7,p.length));},_getMaxItemOfDocumentIteminModel:function(d,o){var m={};if(!o){m=this.getView().getModel("oFrontend");}else{m=o;}var I=m.getProperty("/Items");var b=0;for(var i=0;i<I.length;i++){if((I[i].DocumentItem===d)&&(I[i].ItemCounter>b)){b=I[i].ItemCounter;}}return b;},_getInnerAppState:function(){var s={customData:{}};var o=this.getModel("oFrontend").getData();for(var k=0;k<this._oNavigationServiceFields.aHeaderFields.length;k++){s.customData[this._oNavigationServiceFields.aHeaderFields[k]]=o[this._oNavigationServiceFields.aHeaderFields[k]];}s.customData.Temp_Key=this.temp_objectKey;var I;s.customData.Items=[];for(var i=0;i<o.Items.length;i++){I={};if(o.Items[i].Selected===true){for(var j=0;j<this._oNavigationServiceFields.aItemFields.length;j++){I[this._oNavigationServiceFields.aItemFields[j]]=o.Items[i][this._oNavigationServiceFields.aItemFields[j]];}s.customData.Items.push(I);}}return s;},_setSearchPlaceholderText:function(){var s="";if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){s=this.getResourceBundle().getText("SEARCH_PLACEHOLDER_TEXT_PO");if(this._oPersonalizedDataContainer.SelectPO===true&&this._oPersonalizedDataContainer.SelectSTO===true){s=this.getResourceBundle().getText("SEARCH_PLACEHOLDER_TEXT_STO_PO");}else{if(this._oPersonalizedDataContainer.SelectPO===false&&this._oPersonalizedDataContainer.SelectSTO===true){s=this.getResourceBundle().getText("SEARCH_PLACEHOLDER_TEXT_STO");}}}else{s=this.getResourceBundle().getText("SEARCH_PLACEHOLDER_TEXT_DL");}this.getModel("oFrontend").setProperty("/searchPlaceholderText",s);},_setScanButtonVisibility:function(){if(jQuery.support.touch){this.getModel("oFrontend").setProperty("/ScanButtonVisible",this._oPersonalizedDataContainer.EnableBarcodeScanning);}else{this.getModel("oFrontend").setProperty("/ScanButtonVisible",false);}},_evaluateFieldControl:function(s,o,i){if(o.substring(0,1)==="1"){i[s+"Visible"]=true;}else{i[s+"Visible"]=false;}if(o.substring(1,2)==="1"){i[s+"Mandatory"]=true;}else{i[s+"Mandatory"]=false;}if(o.substring(2,3)==="1"){i[s+"Enabled"]=true;}else{i[s+"Enabled"]=false;}if(o.substring(3,4)==="1"){i[s+"ValueHelpVisible"]=true;}else{i[s+"ValueHelpVisible"]=false;}if(o.substring(4,5)==="1"){i[s+"CreateButtonVisible"]=true;}else{i[s+"CreateButtonVisible"]=false;}},_isExtendedField:function(s){if(s.lastIndexOf("_COB")===s.length-4){return true;}else{return false;}},handleViewSettingsDialogButtonPressed:function(e){if(!this._oSettingsDialog){this._oSettingsDialog=sap.ui.xmlfragment("s2p.mm.im.goodsreceipt.purchaseorder.view.settings",this);this.getView().addDependent(this._oSettingsDialog);}this._oSettingsDialog.open();},handleViewSettingsConfirm:function(e){var v=this.getView();var t=v.byId("idProductsTable");var p=e.getParameters();var b=t.getBinding("items");var s=[];var P=p.sortItem.getKey();var d=p.sortDescending;s.push(new sap.ui.model.Sorter(P,d));if(P=="Material"||P=="MaterialName"){s.push(new sap.ui.model.Sorter("DocumentItem_int",false));}s.push(new sap.ui.model.Sorter("ItemCounter",false));b.sort(s);},handleViewSettingsCancel:function(e){},handlePost:function(){if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){sap.ui.getCore().getMessageManager().removeAllMessages();}var m=this.getView().getModel("oFrontend");var d=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd",UTC:"true"});var j=m.getData();var o={};var c=[];o.InboundDelivery="";var D=m.getProperty("/DocumentDate");o.DocumentDate=d.format(this._oDateFormat.parse(D))+"T00:00:00";D=m.getProperty("/PostingDate");o.PostingDate=d.format(this._oDateFormat.parse(D))+"T00:00:00";o.InboundDelivery=m.getProperty("/Ebeln");o.SourceOfGR=this._SourceOfGR;o.DeliveryDocumentByVendor=m.getProperty("/DeliveryDocumentByVendor");o.MaterialDocumentHeaderText=m.getProperty("/MaterialDocumentHeaderText");o.Temp_Key=this.temp_objectKey;o.BillOfLading=m.getProperty("/BillOfLading");o.VersionForPrintingSlip=m.getProperty("/VersionForPrintingSlip_selectedKey");var I;o.Header2Items=new Array();for(var i=0;i<j.Items.length;i++){I={};I.Material=j.Items[i].Material;I.InboundDelivery=m.getProperty("/Ebeln");I.DeliveryDocumentItem=j.Items[i].DocumentItem;I.DocumentItemText=j.Items[i].DocumentItemText;I.QuantityInEntryUnit=""+j.Items[i].DeliveredQuantity_input;I.EntryUnit=j.Items[i].DeliveredUnit_input;I.OpenQuantity=j.Items[i].OpenQuantity;I.UnitOfMeasure=j.Items[i].Unit;I.Plant=j.Items[i].Plant;I.StorageLocation=j.Items[i].StorageLocation;I.StockType=j.Items[i].StockType_selectedKey;if(I.StockType===" "){I.StockType="";}I.Batch=j.Items[i].Batch;I.AcctAssignmentCategory=j.Items[i].AcctAssignmentCategory;I.AssetNumber=j.Items[i].AssetNumber;I.AssetNumberName=j.Items[i].AssetNumberName;I.SubAssetNumber=j.Items[i].SubAssetNumber;I.GLAccount=j.Items[i].GLAccount;I.GLAccountName=j.Items[i].GLAccountName;I.Project=j.Items[i].Project;I.ProjectDescription=j.Items[i].ProjectDescription;if(j.Items[i].DeliveryCompleted===true){I.DeliveryCompleted="X";}I.GoodsMovementReasonCode=j.Items[i].GoodsMovementReasonCode_selectedKey;if(this._aExtendedFields&&this._aExtendedFields.length>0){for(var k=0;k<this._aExtendedFields.length;k++){if(this._isExtendedField(this._aExtendedFields[k].name)===true){I[this._aExtendedFields[k].name]=j.Items[i][this._aExtendedFields[k].name];}}}if(I.QuantityInEntryUnit>=0&&j.Items[i].Selected===true){o.Header2Items.push(I);}}this._toggleBusy(true);this.getView().getModel("oData").create("/GR4PO_DL_Headers",o,{success:jQuery.proxy(this._handlePostSuccess,this),error:jQuery.proxy(this._handleOdataError,this)});},_handlePostSuccess:function(d,r){this._toggleBusy(false);var o=r.headers["sap-message"];var j=JSON.parse(o);if(j.code==="MIGO/012"){this._initialDataLoaded=null;var p=new sap.ui.model.json.JSONModel();var m=decodeURIComponent(j.message).split(" ");p.setProperty("/MaterialDocument",m[m.length-3]);p.setProperty("/MaterialDocumentYear",m[m.length-2]);p.setProperty("/MessageText",decodeURIComponent(j.message));p.setProperty("/LinkActive",this._isIntentSupported.GoodsReceiptDisplay);this._oPostDialog.setModel(p);this._oPostDialog.open();this.getView().getModel("oFrontend").setData(this._getInitFrontend());this._ResetStorageLocationBuffer=true;this._ResetBatchBuffer=true;this.getView().byId("idProductsTable").getBinding("items").filter([]);this.getView().byId("idSelectAll").setSelected(false);this.getView().byId("idTableSearch").setValue("");this.getView().byId("POInput").setValue("");this.getView().byId("POInput").setEditable(true);if(this.oCompAttachProj){this.oCompAttachProj.destroy(true);delete this.oCompAttachProj;}}else{if(j.code==="MBND_CLOUD/002"){var R=[];var b={};b.MessageText=j.message;b.Severity=j.severity;var m=j.target.split(";");b.valueState=(m[m.length-1]+"_valueState");b.valueStateText=(m[m.length-1]+"_valueStateText");b.DocumentItem=m[m.length-2];R.push(b);for(var i=0;i<j.details.length;i++){b={};b.MessageText=j.details[i].message;b.Severity=j.details[i].severity;var m=j.details[i].target.split(";");b.valueState=(m[m.length-1]+"_valueState");b.valueStateText=(m[m.length-1]+"_valueStateText");b.DocumentItem=m[m.length-2];R.push(b);}this._SetStatus(R,this.getView().getModel("oFrontend"),d);}this.getView().getModel("message").fireMessageChange();}},_SetStatus:function(r,o,d){var b={};if(!o){b=this.getView().getModel("oFrontend");}else{b=o;}var I=b.getProperty("/Items");for(var i=0;i<r.length;i++){for(var y=0;y<I.length;y++){if(r[i].DocumentItem==I[y].DocumentItem){if(r[i].valueState=="DocumentItem_valueState"){I[y].Selected=false;I[y].SelectEnabled=false;I[y].ItemEnabled=false;I[y].SplitEnabled=false;}else{I[y][r[i].valueState]=sap.ui.core.ValueState.Warning;I[y][r[i].valueStateText]=r[i].MessageText;for(var z=0;z<d.Header2Items.results.length;z++){if(I[y].DocumentItem==d.Header2Items.results[z].DeliveryDocumentItem){I[y].Unit=d.Header2Items.results[z].UnitOfMeasure;I[y].OpenQuantity=d.Header2Items.results[z].OpenQuantity;if(I[y].ItemCounter==0){I[y].DeliveredQuantity_input=d.Header2Items.results[z].QuantityInEntryUnit;}else{I[y].DeliveredQuantity_input=0;}I[y].DeliveredUnit_input=d.Header2Items.results[z].EntryUnit;}}}}}}b.setProperty("/Items",I);},handlePostCloseButton:function(e){this._oPostDialog.close();},handleFactSheetLinkPress:function(e){var m=e.getSource().getModel();var s=m.getProperty("/MaterialDocument");var b=m.getProperty("/MaterialDocumentYear");var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"MaterialMovement",action:"displayFactSheet"},params:{MaterialDocument:s,MaterialDocumentYear:b}});},handleDisplayMaterialLinkPress:function(e){var m=e.getSource().data("Material");this._nav2Material(m);},handleDisplaySupplierLinkPress:function(e){var o=this.getView().getModel("oFrontend");this._nav2Supplier(o.getProperty("/Lifnr"));},handleDisplayPurchaseOrderLinkPress:function(e){var o=this.getView().getModel("oFrontend");this._nav2PurchaseOrderOrInboundDelivery(o.getProperty("/Ebeln"));},handleScanSuccess:function(e){if(e.getParameters().cancelled===false&&e.getParameters().text!==""&&jQuery.isNumeric(e.getParameters().text)===true){var p=this.getView().byId("POInput");p.setValue(e.getParameters().text);p.fireChangeEvent(e.getParameters().text);}},handleInputChangeEvent:function(e){var s=e.getParameters().value;var t=this;var r=t.getResourceBundle();var C=true;var m=this.getView().getModel("oFrontend").getProperty("/Ebeln_possibleLength");var c=JSON.stringify(this.getView().getModel("oFrontend").getData());if(c&&this._initialDataLoaded&&(this._initialDataLoaded!=null)){var o=JSON.stringify(this._initialDataLoaded);if(o!==c){var C=false;sap.m.MessageBox.confirm(r.getText("MESSAGE_DATA_LOSS"),{icon:sap.m.MessageBox.Icon.QUESTION,title:r.getText("MESSAGE_DATA_LOSS_TITLE"),onClose:b,styleClass:"sapUiSizeCompact",initialFocus:sap.m.MessageBox.Action.CANCEL});}}if(C===true){if(m.indexOf(s.length)!==-1&&jQuery.isNumeric(s)===true){this._readPO(s);}else{this._toggleBusy(false);this.getView().byId("POInput").fireSuggest({suggestedValue:s});}if(this.oCompAttachProj){this.oCompAttachProj.destroy(true);delete this.oCompAttachProj;}}function b(R){if(R==="OK"){if(t.oCompAttachProj){t.oCompAttachProj.destroy(true);delete t.oCompAttachProj;}if(m.indexOf(s.length)!==-1&&jQuery.isNumeric(s)===true){t._readPO(s);}else{t._toggleBusy(false);t.getView().byId("POInput").fireSuggest({suggestedValue:s});}}else{var p=t.getView().byId("POInput");p.setValue(t._initialDataLoaded.Ebeln);}}},_nav2Material:function(m){var p={Material:m};var r=sap.ui.core.UIComponent.getRouterFor(this);r.stop();var h=sap.ui.core.routing.HashChanger.getInstance();h.setHash("");this._oNavigationService.navigate("Material","displayFactSheet",p,this._getInnerAppState());},_nav2Supplier:function(l){var p={Supplier:l};var r=sap.ui.core.UIComponent.getRouterFor(this);r.stop();var h=sap.ui.core.routing.HashChanger.getInstance();h.setHash("");this._oNavigationService.navigate("Supplier","displayFactSheet",p,this._getInnerAppState());},_nav2PurchaseOrderOrInboundDelivery:function(e){var s="";var p={};if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){s="PurchaseOrder";p={PurchaseOrder:e};}else{s="InboundDelivery";p={InboundDelivery:e};}var r=sap.ui.core.UIComponent.getRouterFor(this);r.stop();var h=sap.ui.core.routing.HashChanger.getInstance();h.setHash("");this._oNavigationService.navigate(s,"displayFactSheet",p,this._getInnerAppState());},_readPO:function(p,A){var t=this;var b=[];if(p){if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){sap.ui.getCore().getMessageManager().removeAllMessages();}if(this._SourceOfGR===this._SourceOfGRIsInboundDelivery){p="0"+p;}b.push(new sap.ui.model.Filter("SourceOfGR",sap.ui.model.FilterOperator.EQ,this._SourceOfGR));b.push(new sap.ui.model.Filter("InboundDelivery",sap.ui.model.FilterOperator.EQ,p));this._toggleBusy(true);this.getOwnerComponent().getModel("oData").read("/GR4PO_DL_Headers",{urlParameters:{$expand:"Header2Items,Header2Items/Item2StockTypes"},filters:b,success:jQuery.proxy(this._successPOLoad,this,A),error:jQuery.proxy(this._handleOdataError,this)});}},_successPOLoad:function(A,d,r){var b=false;var h=r.headers["sap-message"];if(h){var o=JSON.parse(h);if(o.code&&o.severity==="error"){b=true;this.getView().byId("POInput")._lastValue="";}}if(d.results.length===0){b=true;this.getView().byId("POInput")._lastValue="";}if(b===false){var m=this.getView().getModel("oFrontend");var s=false;var c={};c.maxFractionDigits="3";c.visible=true;c.personalizationEnabled=true;c.SupplierDisplayActive=this._isIntentSupported.SupplierDisplay;c.PurchaseOrderDisplayActive=this._isIntentSupported.PurchaseOrderDisplay;c.CreateBatchActive=this._isIntentSupported.BatchCreate;c.MaterialDisplayActive=this._isIntentSupported.MaterialDisplay;c.VersionForPrintingSlip=this._aVersionForPrintingSlip;c.VersionForPrintingSlip_selectedKey="0";this._iTableRowsCount=d.results[0].Header2Items.results.length;c.POItemsCountTableHeader=this.getResourceBundle().getText("TABLE_ITEMS_LABEL",[this._iTableRowsCount,this._iTableRowsCount]);c.Lifname=d.results[0].VendorName;c.Lifnr=d.results[0].Vendor;c.Ebeln=d.results[0].InboundDelivery;c.DocumentDate=this._oDateFormat.format(d.results[0].DocumentDate);c.PostingDate=this._oDateFormat.format(d.results[0].PostingDate);c.DocumentDate_valueState=sap.ui.core.ValueState.None;c.PostingDate_valueState=sap.ui.core.ValueState.None;c.DeliveryDocumentByVendor="";c.MaterialDocumentHeaderText="";c.BillOfLading="";c.PurchasingDocumentType=d.results[0].PurchasingDocumentType;c.PurchasingDocumentTypeName=d.results[0].PurchasingDocumentTypeName;c.SupplyingPlant=d.results[0].SupplyingPlant;c.SupplyingPlantName=d.results[0].SupplyingPlantName;c.ColumnAccountAssignmentVisible=false;c.ColumnSplitVisible=false;c.ColumnPlantVisible=false;c.ColumnStorageLocationVisible=false;c.ColumnStockTypeVisible=false;c.ColumnBatchVisible=false;c.Items=[];for(var i=0;i<d.results[0].Header2Items.results.length;i++){var u=[];u[0]={};c.Items[i]={};c.Items[i].ItemCounter=0;c.Items[i].Selected=false;if(d.results[0].Header2Items.results[i].OpenQuantity>=0){c.Items[i].SelectEnabled=true;}else{c.Items[i].SelectEnabled=false;}c.Items[i].OpenQuantity_valueState=sap.ui.core.ValueState.None;c.Items[i].OpenQuantity_valueStateText="";c.Items[i].SplitEnabled=true;c.Items[i].DocumentItem=d.results[0].Header2Items.results[i].DeliveryDocumentItem;c.Items[i].DocumentItem_int=parseInt(d.results[0].Header2Items.results[i].DeliveryDocumentItem);c.Items[i].Material=d.results[0].Header2Items.results[i].Material;c.Items[i].MaterialName=d.results[0].Header2Items.results[i].MaterialName;c.Items[i].DocumentItemText=d.results[0].Header2Items.results[i].DocumentItemText;c.Items[i].PurchaseOrderItemText=d.results[0].Header2Items.results[i].PurchaseOrderItemText;if(c.Items[i].PurchaseOrderItemText!==""){c.Items[i].MaterialText=c.Items[i].PurchaseOrderItemText;}else{c.Items[i].MaterialText=c.Items[i].MaterialName;}if(this._oPersonalizedDataContainer.PresetDocumentItemTextFromPO===true){c.Items[i].DocumentItemText=c.Items[i].PurchaseOrderItemText;}c.Items[i].Unit=d.results[0].Header2Items.results[i].UnitOfMeasure;c.Items[i].OpenQuantity=d.results[0].Header2Items.results[i].OpenQuantity;c.Items[i].OpenQuantity_number=parseFloat(d.results[0].Header2Items.results[i].OpenQuantity);c.Items[i].OrderedQuantity=d.results[0].Header2Items.results[i].OrderedQuantity;c.Items[i].OrderedQuantity_number=parseFloat(d.results[0].Header2Items.results[i].OrderedQuantity);c.Items[i].OrderedQuantityUnit=d.results[0].Header2Items.results[i].OrderedQuantityUnit;if(d.results[0].Header2Items.results[i].DeliveryCompleted==""){c.Items[i].DeliveryCompleted=false;}else{c.Items[i].DeliveryCompleted=true;}if(parseFloat(c.Items[i].OpenQuantity)>0){c.Items[i].ItemEnabled=true;c.Items[i].MaterialVisible=true;}else{c.Items[i].ItemEnabled=false;c.Items[i].SplitEnabled=false;c.Items[i].MaterialVisible=true;}c.Items[i].SplitButtonIcon="sap-icon://add";if(this._oPersonalizedDataContainer.deliveredQuantityDefault2open===true){c.Items[i].DeliveredQuantity_input=parseFloat(d.results[0].Header2Items.results[i].QuantityInEntryUnit);}else{c.Items[i].DeliveredQuantity_input=parseFloat("0.00");}c.Items[i].DeliveredQuantity_valueState=sap.ui.core.ValueState.None;c.Items[i].DeliveredQuantity_valueStateText="";c.Items[i].DeliveredUnit_input=d.results[0].Header2Items.results[i].EntryUnit;c.Items[i].DeliveredUnit_valueState=sap.ui.core.ValueState.None;c.Items[i].DeliveredUnit_valueStateText="";c.Items[i].Plant_input=d.results[0].Header2Items.results[i].PlantName;c.Items[i].Plant=d.results[0].Header2Items.results[i].Plant;c.Items[i].Batch=d.results[0].Header2Items.results[i].Batch;c.Items[i].IsConsumptionMovement=d.results[0].Header2Items.results[i].IsConsumptionMovement;c.Items[i].AcctAssignmentCategory=d.results[0].Header2Items.results[i].AcctAssignmentCategory;c.Items[i].AcctAssignmentCategoryName=d.results[0].Header2Items.results[i].AcctAssignmentCategoryName;if(c.Items[i].IsConsumptionMovement===false){c.Items[i].AccountAssignmentVisible=false;c.Items[i].PlantVisible=true;c.Items[i].StorageLocationVisible=true;c.Items[i].StockTypeVisible=true;c.ColumnSplitVisible=true;c.ColumnPlantVisible=true;c.ColumnStorageLocationVisible=true;c.ColumnStockTypeVisible=true;}else{c.Items[i].AccountAssignmentVisible=true;c.Items[i].SplitEnabled=false;c.Items[i].PlantVisible=false;c.Items[i].StorageLocationVisible=false;c.Items[i].StockTypeVisible=false;c.ColumnAccountAssignmentVisible=true;}c.Items[i].AssetNumber=d.results[0].Header2Items.results[i].AssetNumber;c.Items[i].AssetNumberName=d.results[0].Header2Items.results[i].AssetNumberName;c.Items[i].SubAssetNumber=d.results[0].Header2Items.results[i].SubAssetNumber;c.Items[i].GLAccount=d.results[0].Header2Items.results[i].GLAccount;c.Items[i].GLAccountName=d.results[0].Header2Items.results[i].GLAccountName;c.Items[i].Project=d.results[0].Header2Items.results[i].Project;c.Items[i].ProjectDescription=d.results[0].Header2Items.results[i].ProjectDescription;c.Items[i].InventorySpecialStockType=d.results[0].Header2Items.results[i].InventorySpecialStockType;c.Items[i].InventorySpecialStockTypeName=d.results[0].Header2Items.results[i].InventorySpecialStockTypeName;c.Items[i].Lifname=d.results[0].VendorName;c.Items[i].Lifnr=d.results[0].Vendor;c.Items[i].GoodsRecipientName=d.results[0].Header2Items.results[i].GoodsRecipientName;c.Items[i].UnloadingPointName=d.results[0].Header2Items.results[i].UnloadingPointName;c.Items[i].FunctionalArea=d.results[0].Header2Items.results[i].FunctionalArea;c.Items[i].ProfitCenter=d.results[0].Header2Items.results[i].ProfitCenter;c.Items[i].ProfitCenterName=d.results[0].Header2Items.results[i].ProfitCenterName;c.Items[i].CostCenter=d.results[0].Header2Items.results[i].CostCenter;c.Items[i].CostCenterName=d.results[0].Header2Items.results[i].CostCenterName;c.Items[i].SalesOrder=d.results[0].Header2Items.results[i].SalesOrder;c.Items[i].SalesOrderItem=d.results[0].Header2Items.results[i].SalesOrderItem;c.Items[i].OrderID=d.results[0].Header2Items.results[i].OrderID;c.Items[i].StorageLocation=d.results[0].Header2Items.results[i].StorageLocation;c.Items[i].StorageLocation_input=d.results[0].Header2Items.results[i].StorageLocationName;c.Items[i].GoodsMovementReasonCode_selectedKey=d.results[0].Header2Items.results[i].GoodsMovementReasonCode;if(c.Items[i].AcctAssignmentCategory===""){if(c.Items[i].StorageLocation===""&&c.Items[i].DeliveredQuantity_input>0){c.Items[i].StorageLocation_valueState=sap.ui.core.ValueState.Error;c.Items[i].StorageLocation_valueStateText=this.getResourceBundle().getText("STORAGELOCATION_VALUE_STATE_TEXT");}else{c.Items[i].StorageLocation_valueState=sap.ui.core.ValueState.None;c.Items[i].StorageLocation_valueStateText="";}}else{c.Items[i].StorageLocation_valueState=sap.ui.core.ValueState.None;c.Items[i].StorageLocation_valueStateText="";}if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){c.Items[i].StorageLocationEditable=true;}else{if(c.Items[i].StorageLocation===""){c.Items[i].StorageLocationEditable=true;}else{c.Items[i].StorageLocationEditable=false;}}var S=new Array();var e=false;for(var j=0;j<d.results[0].Header2Items.results[i].Item2StockTypes.results.length;j++){if(d.results[0].Header2Items.results[i].Item2StockTypes.results[j].StockType===""){S.push({key:" ",text:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].StockTypeName,ControlOfBatchTableField:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfBatchTableField,ControlOfReasonCodeTableField:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfReasonCodeTableField});}else{S.push({key:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].StockType,text:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].StockTypeName,ControlOfBatchTableField:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfBatchTableField,ControlOfReasonCodeTableField:d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfReasonCodeTableField});}if(d.results[0].Header2Items.results[i].Item2StockTypes.results[j].StockType===d.results[0].Header2Items.results[i].StockType){e=true;this._evaluateFieldControl("Batch",d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfBatchTableField,c.Items[i]);this._evaluateFieldControl("GoodsMovementReasonCode",d.results[0].Header2Items.results[i].Item2StockTypes.results[j].ControlOfReasonCodeTableField,c.Items[i]);}}c.Items[i].StockType_input=S;if(d.results[0].Header2Items.results[i].StockTypeName!==""&&e===true){c.Items[i].StockType_selectedKey=d.results[0].Header2Items.results[i].StockType;if(c.Items[i].StockType_selectedKey===""){c.Items[i].StockType_selectedKey=" ";}}else{if(S.length>0){c.Items[i].StockType_selectedKey=S[0].key;this._evaluateFieldControl("Batch",S[0].ControlOfBatchTableField,c.Items[i]);this._evaluateFieldControl("GoodsMovementReasonCode",S[0].ControlOfReasonCodeTableField,c.Items[i]);}else{c.Items[i].StockType_selectedKey=" ";s=true;}}if(c.Items[i].StockType_input.length>1){c.Items[i].StockTypeEnabled=true;}else{c.Items[i].StockTypeEnabled=false;}if(c.Items[i].BatchVisible===true){c.ColumnBatchVisible=true;}c.Items[i].SelectEnabled=this._ItemConsistent(c.Items[i],c.Items);c.Items[i].ApplyButtonEnabled=c.Items[i].SelectEnabled;c.Items[i].DetailHeaderText=(this.getResourceBundle().getText("DETAILSCREEN_TITLE")+" "+c.Items[i].MaterialName+" ("+c.Items[i].Material+")");if(this._aExtendedFields&&this._aExtendedFields.length>0){for(var k=0;k<this._aExtendedFields.length;k++){if(this._isExtendedField(this._aExtendedFields[k].name)===true){c.Items[i][this._aExtendedFields[k].name]=d.results[0].Header2Items.results[i][this._aExtendedFields[k].name];}}}}if(c.SupplyingPlant!==""){c.Objectheader=this.formatter.concatenateNameIdFormatter(c.SupplyingPlantName,c.SupplyingPlant);c.SupplierDisplayActive=false;}else{c.Objectheader=c.Lifname;}if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){c.fullscreenTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_PO");c.shareOnJamTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_PO");c.searchFieldLabel=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_PO");c.Ebeln_label=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_PO");c.Ebeln_maxLength=10;}else{c.fullscreenTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_DL");c.shareOnJamTitle=this.getResourceBundle().getText("FULLSCREEN_TITLE_DL");c.searchFieldLabel=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_DL");c.Ebeln_label=this.getResourceBundle().getText("SEARCH_FIELD_LABEL_DL");c.Ebeln_maxLength=9;}c.SourceOfGR=this._SourceOfGR;if(this._aExtendedFields.length>0){c.ExtensionSectionVisible=true;}else{c.ExtensionSectionVisible=false;}c.Ebeln_possibleLength=this.getView().getModel("oFrontend").getProperty("/Ebeln_possibleLength");c.maxSuggestionWidth=this.getView().getModel("oFrontend").getProperty("/maxSuggestionWidth");var O=false;m.setData(c);this._setBookmark(c.Ebeln);this._setSearchPlaceholderText();this._setScanButtonVisibility();this.getView().bindElement({path:"/GR4PO_DL_Headers(InboundDelivery='"+c.Ebeln+"',SourceOfGR='"+this._SourceOfGR+"')",model:"oData"});this._initialDataLoaded=JSON.parse(JSON.stringify(c));m.setProperty("/PostButtonVisible",true);var g=[];g.push(new sap.ui.model.Sorter("DocumentItem_int",false));g.push(new sap.ui.model.Sorter("ItemCounter",false));this.getView().byId("idProductsTable").removeSelections(true);this.getView().byId("idProductsTable").getBinding("items").filter([]);this.getView().byId("idProductsTable").getBinding("items").sort(g);m.updateBindings(true);this.getView().byId("idTableSearch").setValue("");this._controlSelectAllAndPostButton();this._loadAttachmentComponent();if(O===true){M.show(this.getResourceBundle().getText("MESSAGE_CHANGED_PO"));}if(s===true){this._toggleBusy(false);M.show(this.getResourceBundle().getText("MESSAGE_CONFIGURATION"));}}this._toggleBusy(false);},_setBookmark:function(p){var c=sap.ushell.Container.getService("CrossApplicationNavigation");var h="";var s="";var P={};var t="";if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){s="PurchaseOrder";P={"PurchaseOrder":[p],"SourceOfGR":[this._SourceOfGR]};t=this.getResourceBundle().getText("FULLSCREEN_TITLE_PO");}else{s="InboundDelivery";P={"InboundDelivery":[p],"SourceOfGR":[this._SourceOfGR]};t=this.getResourceBundle().getText("FULLSCREEN_TITLE_DL");}h=(c&&c.hrefForExternal({target:{semanticObject:s,action:"createGR"},params:P}))||"";var e="";var u=(new URI()).toString().split("#");e=(c&&c.hrefForExternal({target:{semanticObject:s,action:"createGR"},params:P}),this.getOwnerComponent())||"";if(u[0]){e=u[0]+h;}this.getView().getModel("oFrontend").setProperty("/saveAsTileTitle",t);this.getView().getModel("oFrontend").setProperty("/saveAsTileSubtitle",p);this.getView().getModel("oFrontend").setProperty("/saveAsTileURL",e);this.getView().getModel("oFrontend").setProperty("/shareInJamURL",e);if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){this.getView().getModel("oFrontend").setProperty("/shareSendEmailSubject",this.getResourceBundle().getText("EMAIL_SUBJECT_PO",[p]));this.getView().getModel("oFrontend").setProperty("/shareSendEmailMessage",this.getResourceBundle().getText("EMAIL_BODY_PO",[p,e]));}else{this.getView().getModel("oFrontend").setProperty("/shareSendEmailSubject",this.getResourceBundle().getText("EMAIL_SUBJECT_DL",[p]));this.getView().getModel("oFrontend").setProperty("/shareSendEmailMessage",this.getResourceBundle().getText("EMAIL_BODY_DL",[p,e]));};},handleSelectDeliveryCompleted:function(e){var d=e.getParameter("selected");var m=this.getView().getModel("oItem");if(d){m.setProperty("/Selected",d);}},onPersoButtonPressed:function(e){if(!this._oPersDialog){this._oPersDialog=sap.ui.xmlfragment("s2p.mm.im.goodsreceipt.purchaseorder.view.personalization",this);this.getView().addDependent(this._oPersDialog);}var p=new sap.ui.model.json.JSONModel();p.setData(JSON.parse(JSON.stringify(this._oPersonalizedDataContainer)));this._oPersDialog.setModel(p);this._oPersDialog.open();},handlePersonalizationSave:function(e){var m=this._oPersDialog.getModel();this._oPersonalizedDataContainer=m.getData();if(this._oPersonalizer){var o=this.getView().getModel("oFrontend");o.setProperty("/personalizationEnabled",false);var s=this._oPersonalizer.setPersData(this._oPersonalizedDataContainer).done(function(){o.setProperty("/personalizationEnabled",true);}).fail(function(){jQuery.sap.log.error("Writing personalization data failed.");o.setProperty("/personalizationEnabled",true);});}this._oPersDialog.close();},handlePersonalizationAbort:function(e){this._oPersDialog.close();},_showSettingsDialog:function(e){if(!this._oApplicationSettingsDialog){if(this._SourceOfGR===this._SourceOfGRIsPurchaseOrder){this._oApplicationSettingsDialog=sap.ui.xmlfragment({fragmentName:"s2p.mm.im.goodsreceipt.purchaseorder.view.ApplicationSettingsPurchaseOrder",type:"XML",id:"s2p.mm.im.goodsreceipt.purchaseorder.ApplicationSettings"},this);}else{this._oApplicationSettingsDialog=sap.ui.xmlfragment({fragmentName:"s2p.mm.im.goodsreceipt.purchaseorder.view.ApplicationSettingsInboundDelivery",type:"XML",id:"s2p.mm.im.goodsreceipt.purchaseorder.ApplicationSettings"},this);}this.getView().addDependent(this._oApplicationSettingsDialog);}var p=new sap.ui.model.json.JSONModel();p.setData(JSON.parse(JSON.stringify(this._oPersonalizedDataContainer)));this._oApplicationSettingsDialog.setModel(p);this._oApplicationSettingsDialog.open();},handleApplicationSettingsSave:function(e){var m=this._oApplicationSettingsDialog.getModel();this._oPersonalizedDataContainer=m.getData();if(this._oPersonalizer){var o=this.getView().getModel("oFrontend");o.setProperty("/personalizationEnabled",false);var s=this._oPersonalizer.setPersData(this._oPersonalizedDataContainer).done(function(){o.setProperty("/personalizationEnabled",true);}).fail(function(){jQuery.sap.log.error("Writing personalization data failed.");o.setProperty("/personalizationEnabled",true);});}this._setSearchPlaceholderText();this._setScanButtonVisibility();this._oApplicationSettingsDialog.close();},handleApplicationSettingsAbort:function(e){this._oApplicationSettingsDialog.close();},matidformatter:function(s){if(s!==""){s="("+s+")";}return s;},soformatter:function(s,S){return s+"/"+S;}});});
